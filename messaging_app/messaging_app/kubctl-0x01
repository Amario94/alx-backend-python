#!/bin/bash
# Script to scale Django app in Kubernetes and perform load testing

set -e  # Exit immediately if a command fails

DEPLOYMENT_NAME="django-deployment"  # Change this if your deployment has a different name
NAMESPACE="default"                 # Change if youâ€™re using another namespace
SERVICE_PORT=8000                   # The port Django app exposes in Kubernetes

echo "ğŸš€ Scaling $DEPLOYMENT_NAME to 3 replicas..."
kubectl scale deployment "$DEPLOYMENT_NAME" --replicas=3 --namespace="$NAMESPACE"

echo "â³ Waiting for pods to be ready..."
kubectl rollout status deployment/"$DEPLOYMENT_NAME" --namespace="$NAMESPACE"

echo "ğŸ“¦ Current pods:"
kubectl get pods --namespace="$NAMESPACE" -o wide

echo "ğŸŒ Getting service IP..."
SERVICE_IP=$(minikube service "$DEPLOYMENT_NAME" --url --namespace="$NAMESPACE" | head -n 1)

if [ -z "$SERVICE_IP" ]; then
    echo "âŒ Could not retrieve service IP. Make sure the service is exposed."
    exit 1
fi
echo "âœ… Service URL: $SERVICE_IP"

echo "ğŸ“Š Running load test with wrk..."
wrk -t4 -c100 -d15s "$SERVICE_IP"

echo "ğŸ“ˆ Monitoring resource usage..."
kubectl top pods --namespace="$NAMESPACE"
